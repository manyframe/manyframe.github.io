<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile to PC Transfer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        h1 { margin-bottom: 20px; }

        .container {
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .box {
            border: 2px solid #333;
            background-color: #111;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #qrcode {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin: 20px 0;
        }
        #qrcode img { display: block; }

        .status {
            color: #888;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .status.connected { color: #4caf50; font-weight: bold; }
        .status.error { color: #d32f2f; }

        /* Form Elements */
        textarea {
            width: 100%;
            height: 100px;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            margin-bottom: 15px;
        }

        .file-label {
            background: #333;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 15px;
            transition: background 0.2s;
            border: 1px solid #444;
        }
        .file-label:hover { background: #444; }
        
        button {
            padding: 12px 30px;
            font-size: 16px;
            background-color: #fff;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Received Items */
        .received-list {
            width: 100%;
            text-align: left;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .received-item {
            background: #222;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #333;
            word-break: break-all;
        }
        .received-item a { color: #4caf50; text-decoration: none; border-bottom: 1px solid #4caf50; }
        .received-item .meta { font-size: 12px; color: #888; margin-bottom: 5px; display: block; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>Mobile <-> PC</h1>

    <!-- PC View -->
    <div class="container" id="pc-view">
        <div class="box">
            <div class="status" id="pc-status">Initializing ID...</div>
            <div id="qrcode"></div>
            <p style="color: #888; font-size: 14px;">·Éì·Éê·Éê·É°·Éô·Éê·Éú·Éî·É†·Éî ·É¢·Éî·Éö·Éî·É§·Éù·Éú·Éò·Éó</p>
        </div>
        <div class="received-list" id="received-list"></div>
    </div>

    <!-- Mobile View -->
    <div class="container hidden" id="mobile-view">
        <div class="box">
            <div class="status" id="mobile-status">Connecting to PC...</div>
            
            <textarea id="msg-input" placeholder="·Éê·Éô·É†·Éò·É§·Éî ·É¢·Éî·É•·É°·É¢·Éò..."></textarea>
            
            <label class="file-label">
                <input type="file" id="file-input" style="display: none;">
                üìé ·É§·Éê·Éò·Éö·Éò·É° ·Éê·É†·É©·Éî·Éï·Éê
            </label>
            <div id="file-name" style="margin-bottom: 15px; font-size: 12px; color: #aaa;"></div>

            <button id="send-btn" disabled>·Éí·Éê·Éí·Éñ·Éê·Éï·Éú·Éê</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('target');
        const peer = new Peer();

        // Elements
        const pcView = document.getElementById('pc-view');
        const mobileView = document.getElementById('mobile-view');
        const pcStatus = document.getElementById('pc-status');
        const mobileStatus = document.getElementById('mobile-status');
        const receivedList = document.getElementById('received-list');
        const msgInput = document.getElementById('msg-input');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const sendBtn = document.getElementById('send-btn');

        let conn = null;

        if (!targetId) {
            // --- PC MODE ---
            peer.on('open', (id) => {
                pcStatus.textContent = "Waiting for connection...";
                const currentUrl = window.location.href.split('?')[0];
                const fullUrl = `${currentUrl}?target=${id}`;
                
                if (window.location.protocol === 'file:') {
                    alert("·Éí·Éê·É§·É†·Éó·ÉÆ·Éò·Éö·Éî·Éë·Éê: ·Éî·É° ·Éí·Éï·Éî·É†·Éì·Éò ·Éí·Éê·ÉÆ·É°·Éú·Éò·Éö·Éò·Éê ·É†·Éù·Éí·Éù·É†·É™ ·É§·Éê·Éò·Éö·Éò. ·É¢·Éî·Éö·Éî·É§·Éù·Éú·Éò ·Éï·Éî·É† ·É®·Éî·Éõ·Éù·Éï·Éê ·Éó·É£ ·Éê·É† ·Éí·Éê·É£·É®·Éï·Éî·Éë·Éó ·Éö·Éù·Éô·Éê·Éö·É£·É† ·É°·Éî·É†·Éï·Éî·É†·Éñ·Éî (Localhost).");
                }

                new QRCode(document.getElementById("qrcode"), {
                    text: fullUrl,
                    width: 200,
                    height: 200
                });
            });

            peer.on('connection', (c) => {
                conn = c;
                pcStatus.textContent = "Connected!";
                pcStatus.className = "status connected";

                conn.on('data', (data) => {
                    const item = document.createElement('div');
                    item.className = 'received-item';

                    if (data.type === 'text') {
                        item.innerHTML = `<span class="meta">Text Received:</span>${data.content}`;
                    } else if (data.type === 'file') {
                        const blob = new Blob([data.file]);
                        const url = URL.createObjectURL(blob);
                        item.innerHTML = `<span class="meta">File Received:</span><a href="${url}" download="${data.name}">${data.name}</a>`;
                    }
                    receivedList.prepend(item);
                });
            });
        } else {
            // --- MOBILE MODE ---
            pcView.classList.add('hidden');
            mobileView.classList.remove('hidden');

            peer.on('open', (id) => {
                conn = peer.connect(targetId);

                conn.on('open', () => {
                    mobileStatus.textContent = "Connected to PC";
                    mobileStatus.className = "status connected";
                    sendBtn.disabled = false;
                });

                conn.on('error', (err) => {
                    mobileStatus.textContent = "Connection Failed";
                    mobileStatus.className = "status error";
                });
            });

            // File selection UI
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    fileNameDisplay.textContent = fileInput.files[0].name;
                }
            });

            // Send Action
            sendBtn.addEventListener('click', () => {
                const text = msgInput.value;
                const file = fileInput.files[0];

                if (text) {
                    conn.send({ type: 'text', content: text });
                    msgInput.value = '';
                }

                if (file) {
                    conn.send({
                        type: 'file',
                        name: file.name,
                        file: file
                    });
                    fileInput.value = '';
                    fileNameDisplay.textContent = '·Éí·Éê·Éí·Éñ·Éê·Éï·Éú·Éò·Éö·Éò·Éê!';
                    setTimeout(() => fileNameDisplay.textContent = '', 2000);
                }
            });
        }
    </script>
</body>
</html>
